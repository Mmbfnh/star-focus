<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نجم التركيز - منصة تعليمية متكاملة</title>
    
    <!-- المكتبات الخارجية -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        /* أنماط Tailwind الأساسية */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        
        .min-h-screen {
            min-height: 100vh;
        }
        
        .bg-gradient-to-br {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hover-lift {
            transition: all 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification-success {
            background: rgba(34, 197, 94, 0.9);
        }
        
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
        }
        
        .notification-info {
            background: rgba(59, 130, 246, 0.9);
        }
        
        /* أنماط الشبكة */
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        /* التباعد */
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        /* التخطيط */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        
        /* الأبعاد */
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        
        /* التباعد الداخلي والخارجي */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        
        .m-4 { margin: 1rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        
        /* النص */
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        
        .font-bold { font-weight: bold; }
        
        .text-white { color: white; }
        .text-red-300 { color: rgb(252, 165, 165); }
        .text-red-400 { color: rgb(248, 113, 113); }
        
        /* الخلفيات */
        .bg-white { background-color: white; }
        .bg-black { background-color: black; }
        .bg-red-500 { background-color: rgb(239, 68, 68); }
        .bg-green-500 { background-color: rgb(34, 197, 94); }
        .bg-yellow-500 { background-color: rgb(234, 179, 8); }
        .bg-blue-500 { background-color: rgb(59, 130, 246); }
        .bg-gray-500 { background-color: rgb(107, 114, 128); }
        
        .bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-opacity-30 { background-color: rgba(255, 255, 255, 0.3); }
        .bg-opacity-50 { background-color: rgba(0, 0, 0, 0.5); }
        
        /* الحدود */
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border-width: 1px; }
        .border-red-500 { border-color: rgb(239, 68, 68); }
        
        /* الظلال */
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        /* تأثيرات */
        .backdrop-blur-lg { backdrop-filter: blur(16px); }
        
        /* التموضع */
        .fixed { position: fixed; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        .top-4 { top: 1rem; }
        .bottom-4 { bottom: 1rem; }
        .left-4 { left: 1rem; }
        .right-4 { right: 1rem; }
        
        /* z-index */
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        
        /* إخفاء العناصر */
        .hidden { display: none; }
        
        /* التجاوز */
        .overflow-y-auto { overflow-y: auto; }
        
        /* الحجم الأقصى */
        .max-w-xs { max-width: 20rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-4xl { max-width: 56rem; }
        .max-w-7xl { max-width: 80rem; }
        
        .max-h-90vh { max-height: 90vh; }
        
        /* خاصية المؤشر */
        .cursor-pointer { cursor: pointer; }
        
        /* الشفافية */
        .opacity-50 { opacity: 0.5; }
        .opacity-60 { opacity: 0.6; }
        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }
        
        /* التحريك */
        .transition-all { transition: all 0.3s ease; }
        .transition-colors { transition: background-color 0.3s ease; }
        
        .duration-300 { transition-duration: 300ms; }
        
        /* التحريك */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* العناصر النائبة */
        .placeholder-gray-300::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* التحديد */
        .disabled\:opacity-50:disabled {
            opacity: 0.5;
        }
        
        /* التخطيط المخصص */
        .container-padding {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        @media (min-width: 640px) {
            .container-padding {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }
        
        @media (min-width: 1024px) {
            .container-padding {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }
        
        /* شارة Firebase */
        .firebase-badge {
            background: linear-gradient(45deg, #FFCA28, #FFA000);
            color: #5D4037;
            font-weight: bold;
        }
        
        /* الوضع الداكن */
        .dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white;
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // 🔥 Firebase Configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBFrwSTZgNisYmaqidjSAZHWune0157vyM",
  authDomain: "testjja-21f01.firebaseapp.com",
  projectId: "testjja-21f01",
  storageBucket: "testjja-21f01.firebasestorage.app",
  messagingSenderId: "294541693024",
  appId: "1:294541693024:web:7d57aba3a8f74762c03305",
  measurementId: "G-HT9H2GGJY8"
};

        // Constants
        const DEFAULT_REWARDS = [
            { id: 1, name: "وسام رقمي", type: "digital", starsRequired: 5, icon: "🏆" },
            { id: 2, name: "وقت لعبة 30 دقيقة", type: "real", starsRequired: 10, icon: "🎮" },
            { id: 3, name: "خروج للحديقة", type: "real", starsRequired: 15, icon: "🌳" },
            { id: 4, name: "وجبة مفضلة", type: "real", starsRequired: 20, icon: "🍕" }
        ];

        const AVATARS = ["👦", "👧", "🧑", "👩", "🦸", "🦹", "🧙", "🧚", "👨‍🚀", "👩‍🚀"];
        const DAYS_OF_WEEK = ["السبت", "الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
        const FOCUS_LEVELS = ['منخفض', 'متوسط', 'مرتفع'];
        const PRIORITY_LEVELS = ['منخفض', 'متوسط', 'مرتفع'];

        // Utility Functions
        const utils = {
            calculateAge(birthDate) {
                if (!birthDate) return 0;
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            getCurrentDay() {
                const days = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
                return days[new Date().getDay()];
            },

            formatTime(minutes) {
                const hrs = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hrs > 0 ? `${hrs} ساعة ${mins} دقيقة` : `${mins} دقيقة`;
            },

            generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            },

            validateChildData(childData) {
                const errors = [];
                
                if (!childData.name || childData.name.trim().length < 2) {
                    errors.push("اسم الطفل يجب أن يكون على الأقل حرفين");
                }
                
                if (childData.birthDate) {
                    const birthDate = new Date(childData.birthDate);
                    const today = new Date();
                    if (birthDate > today) {
                        errors.push("تاريخ الميلاد لا يمكن أن يكون في المستقبل");
                    }
                }
                
                if (childData.subjects.length === 0) {
                    errors.push("يجب إضافة مادة واحدة على الأقل");
                }
                
                return errors;
            },
            
            validateParentData(parentData) {
                const errors = [];
                
                if (!parentData.name || parentData.name.trim().length < 2) {
                    errors.push("اسم الأب/الأم يجب أن يكون على الأقل حرفين");
                }
                
                if (!parentData.email || !parentData.email.includes('@')) {
                    errors.push("البريد الإلكتروني غير صالح");
                }
                
                if (!parentData.password || parentData.password.length < 6) {
                    errors.push("كلمة المرور يجب أن تكون على الأقل 6 أحرف");
                }
                
                return errors;
            }
        };

        // Firebase Service
        const firebaseService = {
            db: null,
            auth: null,
            initialized: false,
            error: null,

            init(firebaseConfig) {
                try {
                    console.log("🔄 جاري تهيئة Firebase...");
                    
                    // التحقق من وجود firebaseConfig
                    if (typeof firebaseConfig === 'undefined') {
                        this.error = "firebaseConfig غير معرّف";
                        console.error(this.error);
                        return false;
                    }

                    // التحقق من بيانات التكوين
                    if (!firebaseConfig.apiKey || firebaseConfig.projectId.includes('your-project')) {
                        this.error = "⚠️ يرجى تكوين Firebase باستخدام بيانات مشروعك الحقيقية";
                        console.warn(this.error);
                        return false;
                    }

                    const app = firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    
                    // تمكين وضع عدم الاتصال
                    this.db.enablePersistence().catch((err) => {
                        console.warn('تعطيل وضع عدم الاتصال:', err);
                    });

                    this.initialized = true;
                    console.log("✅ تم تهيئة Firebase بنجاح");
                    return true;
                } catch (error) {
                    this.error = `❌ فشل تهيئة Firebase: ${error.message}`;
                    console.error(this.error);
                    return false;
                }
            },

            async getCollection(collectionName, userId = null) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return [];
                }
                try {
                    let query = this.db.collection(collectionName);
                    
                    // إذا تم توفير معرف المستخدم، فلنفلتر البيانات حسب المستخدم
                    if (userId) {
                        query = query.where('userId', '==', userId);
                    }
                    
                    const snapshot = await query.get();
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`✅ تم تحميل ${data.length} مستند من ${collectionName}`);
                    return data;
                } catch (error) {
                    console.error(`❌ خطأ في جلب ${collectionName}:`, error);
                    throw error;
                }
            },

            async saveDocument(collectionName, document, userId = null) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return null;
                }
                try {
                    // إضافة معرف المستخدم إذا كان متوفراً
                    if (userId) {
                        document.userId = userId;
                    }
                    
                    let docId;
                    if (document.id && document.id.length > 10) {
                        await this.db.collection(collectionName).doc(document.id).set(document, { merge: true });
                        docId = document.id;
                        console.log(`✅ تم تحديث المستند ${docId} في ${collectionName}`);
                    } else {
                        const docRef = await this.db.collection(collectionName).add(document);
                        docId = docRef.id;
                        console.log(`✅ تم إنشاء مستند جديد ${docId} في ${collectionName}`);
                    }
                    return docId;
                } catch (error) {
                    console.error(`❌ خطأ في الحفظ في ${collectionName}:`, error);
                    throw error;
                }
            },

            async deleteDocument(collectionName, docId) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return false;
                }
                try {
                    await this.db.collection(collectionName).doc(docId).delete();
                    console.log(`✅ تم حذف المستند ${docId} من ${collectionName}`);
                    return true;
                } catch (error) {
                    console.error(`❌ خطأ في الحذف من ${collectionName}:`, error);
                    throw error;
                }
            },
            
            // وظائف المصادقة
            async signUp(email, password, parentData) {
                if (!this.initialized) {
                    throw new Error("Firebase غير مهيء");
                }
                
                try {
                    const userCredential = await this.auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // حفظ بيانات الوالدين
                    await this.saveDocument('parents', {
                        ...parentData,
                        id: user.uid,
                        email: email,
                        createdAt: new Date().toISOString()
                    });
                    
                    console.log("✅ تم إنشاء حساب جديد بنجاح");
                    return user;
                } catch (error) {
                    console.error("❌ خطأ في إنشاء الحساب:", error);
                    throw error;
                }
            },
            
            async signIn(email, password) {
                if (!this.initialized) {
                    throw new Error("Firebase غير مهيء");
                }
                
                try {
                    const userCredential = await this.auth.signInWithEmailAndPassword(email, password);
                    console.log("✅ تم تسجيل الدخول بنجاح");
                    return userCredential.user;
                } catch (error) {
                    console.error("❌ خطأ في تسجيل الدخول:", error);
                    throw error;
                }
            },
            
            async signOut() {
                if (!this.initialized) {
                    throw new Error("Firebase غير مهيء");
                }
                
                try {
                    await this.auth.signOut();
                    console.log("✅ تم تسجيل الخروج بنجاح");
                } catch (error) {
                    console.error("❌ خطأ في تسجيل الخروج:", error);
                    throw error;
                }
            },
            
            getCurrentUser() {
                return this.auth ? this.auth.currentUser : null;
            },
            
            onAuthStateChanged(callback) {
                if (!this.auth) return;
                return this.auth.onAuthStateChanged(callback);
            }
        };

        // نظام مراقبة الاتصال
        const ConnectionManager = {
            isOnline: navigator.onLine,
            retryCount: 0,
            maxRetries: 3,

            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('✅ الاتصال عاد');
                    this.retryConnection();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('❌ فقدان الاتصال');
                });

                setInterval(() => {
                    if (!this.isOnline && this.retryCount < this.maxRetries) {
                        this.retryConnection();
                    }
                }, 5000);
            },

            async retryConnection() {
                if (!this.isOnline) return;
                
                try {
                    this.retryCount++;
                    console.log(`🔄 محاولة إعادة الاتصال (${this.retryCount}/${this.maxRetries})`);
                    
                    await this.testFirebaseConnection();
                    this.retryCount = 0;
                    console.log('✅ إعادة الاتصال ناجحة');
                } catch (error) {
                    console.error(`❌ فشل إعادة الاتصال: ${error.message}`);
                }
            },

            async testFirebaseConnection() {
                if (!firebaseService.initialized) return false;
                
                try {
                    const testRef = firebaseService.db.collection('connection_test').doc('ping');
                    await testRef.set({
                        timestamp: new Date().toISOString(),
                        status: 'testing'
                    });
                    return true;
                } catch (error) {
                    throw new Error(`فشل اختبار الاتصال: ${error.message}`);
                }
            }
        };

        // مكون حالة الاتصال
        function ConnectionStatus({ firebaseService }) {
            const [connectionInfo, setConnectionInfo] = React.useState({
                status: 'checking',
                lastSync: null
            });

            React.useEffect(() => {
                const checkConnection = async () => {
                    if (firebaseService.initialized) {
                        try {
                            await ConnectionManager.testFirebaseConnection();
                            setConnectionInfo({
                                status: 'connected',
                                lastSync: new Date()
                            });
                        } catch (error) {
                            setConnectionInfo({
                                status: 'disconnected',
                                lastSync: new Date()
                            });
                        }
                    } else {
                        setConnectionInfo({
                            status: 'disconnected',
                            lastSync: null
                        });
                    }
                };

                if (firebaseService.initialized) {
                    checkConnection();
                    const interval = setInterval(checkConnection, 30000);
                    return () => clearInterval(interval);
                }
            }, [firebaseService.initialized]);

            const statusColors = {
                connected: 'bg-green-500',
                disconnected: 'bg-red-500',
                checking: 'bg-yellow-500'
            };

            if (!firebaseService.initialized && !firebaseService.error) return null;

            return (
                <div className="fixed bottom-4 left-4 z-40">
                    <div className={`p-3 rounded-lg shadow-lg text-white ${
                        statusColors[connectionInfo.status] || 'bg-gray-500'
                    }`}>
                        <div className="flex items-center gap-2">
                            <div className={`w-3 h-3 rounded-full ${
                                connectionInfo.status === 'connected' ? 'bg-green-400 animate-pulse' :
                                connectionInfo.status === 'disconnected' ? 'bg-red-400' : 'bg-yellow-400'
                            }`}></div>
                            <span className="text-sm font-bold">
                                {connectionInfo.status === 'connected' ? '☁️ متصل' :
                                 connectionInfo.status === 'disconnected' ? '❌ غير متصل' : '🔄 جاري الفحص'}
                            </span>
                        </div>
                        {firebaseService.error && (
                            <div className="text-xs mt-1 max-w-xs">
                                {firebaseService.error}
                            </div>
                        )}
                        {connectionInfo.lastSync && (
                            <div className="text-xs mt-1 opacity-80">
                                آخر محاولة: {connectionInfo.lastSync.toLocaleTimeString('ar-EG')}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // مكون تسجيل الدخول/التسجيل
        function AuthScreen({ onLogin, onSignUp }) {
            const [isLogin, setIsLogin] = React.useState(true);
            const [formData, setFormData] = React.useState({
                name: '',
                email: '',
                password: '',
                confirmPassword: ''
            });
            const [loading, setLoading] = React.useState(false);
            const [errors, setErrors] = React.useState([]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setErrors([]);
                setLoading(true);

                try {
                    if (isLogin) {
                        // تسجيل الدخول
                        await onLogin(formData.email, formData.password);
                    } else {
                        // التسجيل
                        if (formData.password !== formData.confirmPassword) {
                            setErrors(['كلمات المرور غير متطابقة']);
                            setLoading(false);
                            return;
                        }

                        const validationErrors = utils.validateParentData({
                            name: formData.name,
                            email: formData.email,
                            password: formData.password
                        });

                        if (validationErrors.length > 0) {
                            setErrors(validationErrors);
                            setLoading(false);
                            return;
                        }

                        await onSignUp(formData.email, formData.password, {
                            name: formData.name,
                            email: formData.email
                        });
                    }
                } catch (error) {
                    setErrors([error.message]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div className="glass-effect rounded-2xl p-8 shadow-xl w-full max-w-md">
                        <h2 className="text-3xl font-bold text-center mb-6 text-white">
                            {isLogin ? 'تسجيل الدخول' : 'إنشاء حساب جديد'}
                        </h2>
                        
                        {errors.length > 0 && (
                            <div className="bg-red-500 bg-opacity-20 border border-red-500 rounded-xl p-4 mb-4">
                                {errors.map((error, index) => (
                                    <p key={index} className="text-red-300 text-sm">{error}</p>
                                ))}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <div>
                                    <label className="block mb-2 text-white">الاسم الكامل</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                                        className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                        placeholder="أدخل اسمك الكامل"
                                    />
                                </div>
                            )}
                            
                            <div>
                                <label className="block mb-2 text-white">البريد الإلكتروني</label>
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                                    className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                    placeholder="example@email.com"
                                />
                            </div>
                            
                            <div>
                                <label className="block mb-2 text-white">كلمة المرور</label>
                                <input
                                    type="password"
                                    value={formData.password}
                                    onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                                    className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                    placeholder="********"
                                />
                            </div>
                            
                            {!isLogin && (
                                <div>
                                    <label className="block mb-2 text-white">تأكيد كلمة المرور</label>
                                    <input
                                        type="password"
                                        value={formData.confirmPassword}
                                        onChange={(e) => setFormData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                        className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                        placeholder="********"
                                    />
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-white bg-opacity-20 text-white p-4 rounded-2xl text-xl font-bold hover:bg-opacity-30 transition-all disabled:opacity-50"
                            >
                                {loading ? 'جاري المعالجة...' : (isLogin ? 'تسجيل الدخول' : 'إنشاء حساب')}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => {
                                    setIsLogin(!isLogin);
                                    setErrors([]);
                                    setFormData({
                                        name: '',
                                        email: '',
                                        password: '',
                                        confirmPassword: ''
                                    });
                                }}
                                className="text-white hover:underline"
                            >
                                {isLogin ? 'ليس لديك حساب؟ سجل الآن' : 'لديك حساب بالفعل؟ سجل الدخول'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // لوحة تحكم الوالدين
        function ParentDashboard({ user, children, onAddChild, onEditChild, onDeleteChild, onLogout }) {
            const [activeTab, setActiveTab] = React.useState("children");
            const [showAddChild, setShowAddChild] = React.useState(false);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
                    {/* الهيدر */}
                    <header className="glass-effect p-4 shadow-lg">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <h1 className="text-2xl font-bold text-white">لوحة تحكم الوالدين</h1>
                                <span className="text-white opacity-80">مرحباً، {user.name}</span>
                            </div>
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={onLogout}
                                    className="p-3 rounded-full glass-effect hover-lift text-white"
                                    title="تسجيل الخروج"
                                >
                                    تسجيل الخروج
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* التنقل */}
                    <nav className="bg-white bg-opacity-20 backdrop-blur-lg p-4">
                        <div className="max-w-7xl mx-auto flex gap-4">
                            <button
                                onClick={() => setActiveTab("children")}
                                className={`p-3 rounded-xl transition-all ${
                                    activeTab === "children" 
                                        ? 'bg-white bg-opacity-30 text-white shadow-lg' 
                                        : 'glass-effect hover-lift text-white'
                                }`}
                            >
                                إدارة الأطفال
                            </button>
                            <button
                                onClick={() => setActiveTab("reports")}
                                className={`p-3 rounded-xl transition-all ${
                                    activeTab === "reports" 
                                        ? 'bg-white bg-opacity-30 text-white shadow-lg' 
                                        : 'glass-effect hover-lift text-white'
                                }`}
                            >
                                التقارير والإحصائيات
                            </button>
                            <button
                                onClick={() => setActiveTab("settings")}
                                className={`p-3 rounded-xl transition-all ${
                                    activeTab === "settings" 
                                        ? 'bg-white bg-opacity-30 text-white shadow-lg' 
                                        : 'glass-effect hover-lift text-white'
                                }`}
                            >
                                الإعدادات
                            </button>
                        </div>
                    </nav>

                    {/* المحتوى */}
                    <main className="max-w-7xl mx-auto p-4">
                        {activeTab === "children" && (
                            <div className="glass-effect rounded-2xl p-6 shadow-xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-white">إدارة الأطفال</h2>
                                    <button
                                        onClick={() => setShowAddChild(true)}
                                        className="bg-white bg-opacity-20 text-white p-3 rounded-xl hover:bg-opacity-30 transition-all"
                                    >
                                        + إضافة طفل جديد
                                    </button>
                                </div>

                                {children.length === 0 ? (
                                    <div className="text-center py-8">
                                        <p className="text-white text-lg mb-4">لا يوجد أطفال مسجلين</p>
                                        <button
                                            onClick={() => setShowAddChild(true)}
                                            className="bg-white bg-opacity-20 text-white p-4 rounded-2xl text-lg hover:bg-opacity-30 transition-all"
                                        >
                                            إضافة أول طفل
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {children.map((child, index) => (
                                            <div key={child.id} className="glass-effect rounded-xl p-4">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="text-3xl">{child.avatar}</span>
                                                    <div>
                                                        <h3 className="text-white font-bold">{child.name}</h3>
                                                        <p className="text-white opacity-70 text-sm">
                                                            العمر: {utils.calculateAge(child.birthDate)} سنة
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2 mb-4">
                                                    <div className="flex justify-between text-white text-sm">
                                                        <span>مستوى التركيز:</span>
                                                        <span>{child.focusLevel}</span>
                                                    </div>
                                                    <div className="flex justify-between text-white text-sm">
                                                        <span>عدد النجوم:</span>
                                                        <span>{child.stars} ⭐</span>
                                                    </div>
                                                    <div className="flex justify-between text-white text-sm">
                                                        <span>المواد الدراسية:</span>
                                                        <span>{child.subjects.length}</span>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => onEditChild(index)}
                                                        className="flex-1 bg-white bg-opacity-20 text-white p-2 rounded-lg text-sm hover:bg-opacity-30 transition-all"
                                                    >
                                                        تعديل
                                                    </button>
                                                    <button
                                                        onClick={() => onDeleteChild(index)}
                                                        className="flex-1 bg-red-500 bg-opacity-20 text-red-300 p-2 rounded-lg text-sm hover:bg-opacity-30 transition-all"
                                                    >
                                                        حذف
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === "reports" && (
                            <div className="glass-effect rounded-2xl p-6 shadow-xl">
                                <h2 className="text-2xl font-bold text-white mb-6">التقارير والإحصائيات</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div className="glass-effect rounded-xl p-4 text-center">
                                        <div className="text-3xl text-white mb-2">{children.length}</div>
                                        <div className="text-white opacity-70">عدد الأطفال</div>
                                    </div>
                                    <div className="glass-effect rounded-xl p-4 text-center">
                                        <div className="text-3xl text-white mb-2">
                                            {children.reduce((total, child) => total + child.subjects.length, 0)}
                                        </div>
                                        <div className="text-white opacity-70">إجمالي المواد</div>
                                    </div>
                                    <div className="glass-effect rounded-xl p-4 text-center">
                                        <div className="text-3xl text-white mb-2">
                                            {children.reduce((total, child) => total + child.stars, 0)}
                                        </div>
                                        <div className="text-white opacity-70">إجمالي النجوم</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === "settings" && (
                            <div className="glass-effect rounded-2xl p-6 shadow-xl">
                                <h2 className="text-2xl font-bold text-white mb-6">الإعدادات</h2>
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center p-4 glass-effect rounded-xl">
                                        <span className="text-white">البريد الإلكتروني</span>
                                        <span className="text-white opacity-70">{user.email}</span>
                                    </div>
                                    <div className="flex justify-between items-center p-4 glass-effect rounded-xl">
                                        <span className="text-white">تاريخ التسجيل</span>
                                        <span className="text-white opacity-70">
                                            {new Date(user.createdAt).toLocaleDateString('ar-EG')}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* نافذة إضافة طفل */}
                    {showAddChild && (
                        <AddChildForm
                            onClose={() => setShowAddChild(false)}
                            onAddChild={onAddChild}
                        />
                    )}
                </div>
            );
        }

        // نموذج إضافة طفل
        function AddChildForm({ onClose, onAddChild }) {
            const [newChild, setNewChild] = React.useState({
                name: "",
                birthDate: "",
                focusLevel: "متوسط",
                wakeTime: "05:30",
                sleepTime: "20:30",
                subjects: [],
                exams: [],
                weeklySchedule: Object.fromEntries(DAYS_OF_WEEK.map(day => [day, []])),
                goals: [],
                stars: 0,
                completed: [],
                achievements: [],
                studyTime: 0,
                avatar: "👦",
                createdAt: new Date().toISOString()
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onAddChild(newChild);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-effect rounded-2xl p-6 shadow-xl w-full max-w-2xl max-h-90vh overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">إضافة طفل جديد</h2>
                            <button
                                onClick={onClose}
                                className="text-white text-2xl hover:opacity-70"
                            >
                                ×
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block mb-2 text-lg text-white">الصورة الرمزية</label>
                                        <div className="flex items-center gap-4">
                                            <button 
                                                type="button"
                                                onClick={() => setNewChild(prev => ({ 
                                                    ...prev, 
                                                    avatar: AVATARS[(AVATARS.indexOf(prev.avatar) + 1) % AVATARS.length] 
                                                }))}
                                                className="text-4xl p-4 rounded-2xl glass-effect hover-lift"
                                            >
                                                {newChild.avatar}
                                            </button>
                                            <span className="text-sm opacity-70 text-white">انقر لتغيير الصورة</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block mb-2 text-lg text-white">اسم الطفل</label>
                                        <input 
                                            type="text"
                                            value={newChild.name}
                                            onChange={(e) => setNewChild(prev => ({ ...prev, name: e.target.value }))}
                                            placeholder="أدخل اسم الطفل"
                                            className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block mb-2 text-lg text-white">تاريخ الميلاد</label>
                                        <input 
                                            type="date"
                                            value={newChild.birthDate}
                                            onChange={(e) => setNewChild(prev => ({ ...prev, birthDate: e.target.value }))}
                                            className="w-full p-3 rounded-xl glass-effect text-white"
                                        />
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block mb-2 text-lg text-white">مستوى التركيز</label>
                                        <div className="flex gap-2">
                                            {FOCUS_LEVELS.map(level => (
                                                <button
                                                    type="button"
                                                    key={level}
                                                    onClick={() => setNewChild(prev => ({ ...prev, focusLevel: level }))}
                                                    className={`flex-1 p-4 rounded-xl transition-all ${
                                                        newChild.focusLevel === level 
                                                            ? 'bg-white bg-opacity-30 text-white shadow-lg' 
                                                            : 'glass-effect hover-lift text-white'
                                                    }`}
                                                >
                                                    {level}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block mb-2 text-lg text-white">وقت الاستيقاظ</label>
                                        <input 
                                            type="time"
                                            value={newChild.wakeTime}
                                            onChange={(e) => setNewChild(prev => ({ ...prev, wakeTime: e.target.value }))}
                                            className="w-full p-3 rounded-xl glass-effect text-white"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block mb-2 text-lg text-white">وقت النوم</label>
                                        <input 
                                            type="time"
                                            value={newChild.sleepTime}
                                            onChange={(e) => setNewChild(prev => ({ ...prev, sleepTime: e.target.value }))}
                                            className="w-full p-3 rounded-xl glass-effect text-white"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* المواد الدراسية */}
                            <div className="mb-6">
                                <h3 className="text-xl font-bold mb-4 text-white">المواد الدراسية</h3>
                                <div className="space-y-2 mb-4">
                                    {newChild.subjects.length === 0 ? (
                                        <p className="text-white text-center py-4">لم يتم إضافة أي مواد بعد</p>
                                    ) : (
                                        newChild.subjects.map((subject, index) => (
                                            <div key={index} className="flex justify-between items-center p-3 glass-effect rounded-xl">
                                                <span className="text-white">{subject.name} - {subject.duration} دقيقة</span>
                                                <button 
                                                    type="button"
                                                    onClick={() => setNewChild(prev => ({
                                                        ...prev,
                                                        subjects: prev.subjects.filter((_, i) => i !== index)
                                                    }))}
                                                    className="text-red-400 hover:text-red-300"
                                                >
                                                    حذف
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <button 
                                    type="button"
                                    onClick={() => {
                                        const name = prompt("أدخل اسم المادة:");
                                        if (!name) return;
                                        
                                        const duration = parseInt(prompt("أدخل مدة المادة بالدقائق:"), 10);
                                        if (isNaN(duration)) {
                                            alert("الرجاء إدخال رقم صحيح للمدة");
                                            return;
                                        }

                                        setNewChild(prev => ({
                                            ...prev,
                                            subjects: [...prev.subjects, { name, duration, id: utils.generateId() }]
                                        }));
                                    }}
                                    className="w-full p-3 glass-effect rounded-xl text-white hover:bg-white hover:bg-opacity-20 transition-all"
                                >
                                    + إضافة مادة جديدة
                                </button>
                            </div>
                            
                            <div className="flex gap-4">
                                <button 
                                    type="submit"
                                    className="flex-1 bg-white bg-opacity-20 text-white p-4 rounded-2xl text-xl font-bold hover:bg-opacity-30 transition-all"
                                >
                                    إضافة الطفل
                                </button>
                                <button 
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-red-500 bg-opacity-20 text-white p-4 rounded-2xl text-xl font-bold hover:bg-opacity-30 transition-all"
                                >
                                    إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Main App Component
        const { useState, useEffect, useCallback } = React;

        function App() {
            const [appState, setAppState] = useState({
                user: null,
                isAuthenticated: false,
                loading: true,
                children: [],
                currentChildIndex: 0,
                activeTab: "الرئيسية",
                darkMode: false,
                useFirebase: false
            });

            const [rewards, setRewards] = useState(DEFAULT_REWARDS);
            const [notification, setNotification] = useState({ show: false, message: "", type: "" });

            // Initialize Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    setAppState(prev => ({ ...prev, loading: true }));
                    
                    if (firebaseService.init(FIREBASE_CONFIG)) {
                        setAppState(prev => ({ ...prev, useFirebase: true }));
                        
                        // مراقبة حالة المصادقة
                        firebaseService.onAuthStateChanged(async (user) => {
                            if (user) {
                                try {
                                    // جلب بيانات الوالدين
                                    const parents = await firebaseService.getCollection('parents');
                                    const parentData = parents.find(p => p.id === user.uid);
                                    
                                    if (parentData) {
                                        // جلب بيانات الأطفال المرتبطة بهذا المستخدم
                                        const childrenData = await firebaseService.getCollection('children', user.uid);
                                        const rewardsData = await firebaseService.getCollection('rewards', user.uid);
                                        
                                        setAppState(prev => ({ 
                                            ...prev, 
                                            user: parentData,
                                            isAuthenticated: true,
                                            children: childrenData,
                                            loading: false
                                        }));
                                        
                                        if (rewardsData.length > 0) {
                                            setRewards(rewardsData);
                                        }
                                        
                                        showNotification(`مرحباً بعودتك، ${parentData.name}`, "success");
                                    }
                                } catch (error) {
                                    console.error("Error loading user data:", error);
                                    showNotification("⚠️ حدث خطأ في تحميل البيانات", "error");
                                }
                            } else {
                                setAppState(prev => ({ 
                                    ...prev, 
                                    user: null,
                                    isAuthenticated: false,
                                    loading: false
                                }));
                            }
                        });
                    } else {
                        setAppState(prev => ({ ...prev, loading: false }));
                        showNotification("📱 يتم استخدام التخزين المحلي", "info");
                    }
                    
                    ConnectionManager.init();
                };

                initFirebase();
            }, []);

            const showNotification = useCallback((message, type = "info") => {
                setNotification({ show: true, message, type });
                setTimeout(() => setNotification({ show: false, message: "", type: "" }), 4000);
            }, []);

            // وظائف المصادقة
            const handleLogin = useCallback(async (email, password) => {
                try {
                    await firebaseService.signIn(email, password);
                } catch (error) {
                    throw error;
                }
            }, []);

            const handleSignUp = useCallback(async (email, password, parentData) => {
                try {
                    await firebaseService.signUp(email, password, parentData);
                } catch (error) {
                    throw error;
                }
            }, []);

            const handleLogout = useCallback(async () => {
                try {
                    await firebaseService.signOut();
                    setAppState(prev => ({ 
                        ...prev, 
                        user: null,
                        isAuthenticated: false,
                        children: []
                    }));
                    showNotification("تم تسجيل الخروج بنجاح", "info");
                } catch (error) {
                    showNotification("حدث خطأ أثناء تسجيل الخروج", "error");
                }
            }, [showNotification]);

            // Child Management
            const addChild = useCallback(async (childData) => {
                const validationErrors = utils.validateChildData(childData);
                if (validationErrors.length > 0) {
                    validationErrors.forEach(error => showNotification(error, "error"));
                    return;
                }

                const childWithId = { ...childData, id: utils.generateId() };
                
                if (appState.useFirebase && appState.user) {
                    try {
                        await firebaseService.saveDocument('children', childWithId, appState.user.id);
                    } catch (error) {
                        console.error("Failed to save child to Firebase:", error);
                        showNotification("⚠️ تم الحفظ محلياً فقط", "warning");
                    }
                }

                setAppState(prev => ({
                    ...prev,
                    children: [...prev.children, childWithId]
                }));
                showNotification(`تمت إضافة الطفل ${childData.name} بنجاح`, "success");
            }, [appState.useFirebase, appState.user, showNotification]);

            const updateChild = useCallback((childIndex, updates) => {
                setAppState(prev => ({
                    ...prev,
                    children: prev.children.map((child, index) =>
                        index === childIndex ? { ...child, ...updates } : child
                    )
                }));
            }, []);

            const deleteChild = useCallback(async (childIndex) => {
                const childName = appState.children[childIndex]?.name;
                if (!childName || !window.confirm(`هل أنت متأكد من حذف ${childName}؟`)) return;

                const childId = appState.children[childIndex].id;

                if (appState.useFirebase) {
                    try {
                        await firebaseService.deleteDocument('children', childId);
                    } catch (error) {
                        console.error("Failed to delete child from Firebase:", error);
                        showNotification("⚠️ تم الحذف محلياً فقط", "warning");
                    }
                }

                setAppState(prev => ({
                    ...prev,
                    children: prev.children.filter((_, index) => index !== childIndex),
                    currentChildIndex: prev.currentChildIndex >= childIndex && prev.currentChildIndex > 0 
                        ? prev.currentChildIndex - 1 
                        : prev.currentChildIndex
                }));

                showNotification(`تم حذف الطفل ${childName}`, "info");
            }, [appState.children, appState.useFirebase, showNotification]);

            // Render based on authentication state
            if (appState.loading) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="glass-effect rounded-2xl p-8 flex flex-col items-center">
                            <div className="loading-spinner mb-4"></div>
                            <div className="text-white text-lg">جاري تحميل البيانات...</div>
                        </div>
                    </div>
                );
            }

            if (!appState.isAuthenticated) {
                return (
                    <>
                        {notification.show && (
                            <div className={`fixed top-4 left-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in glass-effect ${
                                notification.type === "success" ? "notification-success" :
                                notification.type === "error" ? "notification-error" :
                                "notification-info"
                            }`}>
                                <div className="flex justify-between items-center">
                                    <span className="text-lg text-white">{notification.message}</span>
                                    <button 
                                        onClick={() => setNotification({ show: false, message: "", type: "" })} 
                                        className="text-lg font-bold hover:opacity-70 text-white"
                                    >
                                        ×
                                    </button>
                                </div>
                            </div>
                        )}
                        <AuthScreen 
                            onLogin={handleLogin}
                            onSignUp={handleSignUp}
                        />
                    </>
                );
            }

            return (
                <>
                    {appState.useFirebase && <ConnectionStatus firebaseService={firebaseService} />}
                    
                    {notification.show && (
                        <div className={`fixed top-4 left-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in glass-effect ${
                            notification.type === "success" ? "notification-success" :
                            notification.type === "error" ? "notification-error" :
                            "notification-info"
                        }`}>
                            <div className="flex justify-between items-center">
                                <span className="text-lg text-white">{notification.message}</span>
                                <button 
                                    onClick={() => setNotification({ show: false, message: "", type: "" })} 
                                    className="text-lg font-bold hover:opacity-70 text-white"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    )}

                    <ParentDashboard
                        user={appState.user}
                        children={appState.children}
                        onAddChild={addChild}
                        onEditChild={updateChild}
                        onDeleteChild={deleteChild}
                        onLogout={handleLogout}
                    />
                </>
            );
        }

        // Initialize App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
