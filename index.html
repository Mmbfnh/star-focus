<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نجم التركيز - منصة تعليمية متكاملة</title>
    
    <!-- المكتبات الخارجية -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        /* أنماط Tailwind الأساسية */
        .min-h-screen { min-height: 100vh; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .p-4 { padding: 1rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
        .text-white { color: white; }
        .text-4xl { font-size: 2.25rem; }
        .font-bold { font-weight: 700; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-50 { --tw-gradient-from: #eff6ff; }
        .to-purple-50 { --tw-gradient-to: #faf5ff; }
        .rounded-2xl { border-radius: 1rem; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .w-full { width: 100%; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .pt-4 { padding-top: 1rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .p-6 { padding: 1.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-2 { padding: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .whitespace-nowrap { white-space: nowrap; }
        .flex-shrink-0 { flex-shrink: 0; }
        .flex-1 { flex: 1 1 0%; }
        .min-w-32 { min-width: 8rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-sm { font-size: 0.875rem; }
        .opacity-80 { opacity: 0.8; }
        .opacity-70 { opacity: 0.7; }
        .opacity-60 { opacity: 0.6; }
        .transition-all { transition: all 0.3s ease; }
        .transition-colors { transition: colors 0.3s ease; }
        .duration-300 { transition-duration: 300ms; }
        .hover\:bg-opacity-30:hover { background-opacity: 0.3; }
        .hover\:bg-opacity-20:hover { background-opacity: 0.2; }
        .hover\:bg-white:hover { background-color: white; }
        .hover\:bg-green-600:hover { background-color: #059669; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:text-red-300:hover { color: #fca5a5; }
        .hover\:opacity-70:hover { opacity: 0.7; }
        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }
        .hidden { display: none; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-4 { top: 1rem; }
        .left-4 { left: 1rem; }
        .right-4 { right: 1rem; }
        .bottom-4 { bottom: 1rem; }
        .z-50 { z-index: 50; }
        .z-40 { z-index: 40; }
        .border { border-width: 1px; }
        .border-l-4 { border-left-width: 4px; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .placeholder-gray-300::placeholder { color: #d1d5db; }

        /* أنماط الشبكة للشاشات المتوسطة */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:col-span-2 { grid-column: span 2 / span 2; }
        }

        /* أنماط الشبكة للشاشات الكبيرة */
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }

        /* أنماط الألوان */
        .bg-green-500 { background-color: #10b981; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-purple-500 { background-color: #8b5cf6; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-orange-500 { background-color: #f59e0b; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #e9d5ff; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-white { background-color: white; }
        .bg-black { background-color: black; }
        .bg-opacity-50 { background-opacity: 0.5; }
        .bg-opacity-20 { background-opacity: 0.2; }
        .bg-opacity-10 { background-opacity: 0.1; }

        .text-green-800 { color: #166534; }
        .text-blue-800 { color: #1e40af; }
        .text-purple-800 { color: #6b21a8; }
        .text-yellow-800 { color: #854d0e; }
        .text-yellow-700 { color: #a16207; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-500 { color: #6b7280; }
        .text-green-600 { color: #059669; }
        .text-blue-600 { color: #2563eb; }
        .text-purple-600 { color: #7c3aed; }
        .text-red-400 { color: #f87171; }
        .text-yellow-400 { color: #facc15; }
        .text-green-400 { color: #4ade80; }

        .border-green-500 { border-color: #10b981; }
        .border-red-500 { border-color: #ef4444; }
        .border-yellow-500 { border-color: #eab308; }
        .border-yellow-200 { border-color: #fef08a; }

        /* الأنماط الخاصة بالتطبيق */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-gradient: linear-gradient(135deg, #1e293b, #334155);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.18);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: var(--glass-border);
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .float-animation { animation: float 3s ease-in-out infinite; }

        .dark-mode { background: var(--dark-gradient); color: #f1f5f9; }
        .dark-mode .glass-effect { background: rgba(30, 41, 59, 0.7); }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        .notification-success { background: rgba(34, 197, 94, 0.9); }
        .notification-error { background: rgba(239, 68, 68, 0.9); }
        .notification-info { background: rgba(59, 130, 246, 0.9); }

        .priority-high { background: #ef4444; }
        .priority-medium { background: #f59e0b; }
        .priority-low { background: #10b981; }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s ease;
        }
        
        .firebase-badge {
            background: linear-gradient(135deg, #ffa000, #ffca28);
            color: #5d4037;
        }

        @media (max-width: 768px) {
            .container-padding {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // 🔥 Firebase Configuration - استخدم بياناتك الحقيقية هنا
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBFrwSTZgNisYmaqidjSAZHWune0157vyM",
            authDomain: "testjja-21f01.firebaseapp.com",
            projectId: "testjja-21f01",
            storageBucket: "testjja-21f01.firebasestorage.app",
            messagingSenderId: "294541693024",
            appId: "1:294541693024:web:7d57aba3a8f74762c03305",
            measurementId: "G-HT9H2GGJY8"
        };

        // Constants
        const DEFAULT_REWARDS = [
            { id: 1, name: "وسام رقمي", type: "digital", starsRequired: 5, icon: "🏆" },
            { id: 2, name: "وقت لعبة 30 دقيقة", type: "real", starsRequired: 10, icon: "🎮" },
            { id: 3, name: "خروج للحديقة", type: "real", starsRequired: 15, icon: "🌳" },
            { id: 4, name: "وجبة مفضلة", type: "real", starsRequired: 20, icon: "🍕" }
        ];

        const AVATARS = ["👦", "👧", "🧑", "👩", "🦸", "🦹", "🧙", "🧚", "👨‍🚀", "👩‍🚀"];
        const DAYS_OF_WEEK = ["السبت", "الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
        const FOCUS_LEVELS = ['منخفض', 'متوسط', 'مرتفع'];
        const PRIORITY_LEVELS = ['منخفض', 'متوسط', 'مرتفع'];

        // Utility Functions
        const utils = {
            calculateAge(birthDate) {
                if (!birthDate) return 0;
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            getCurrentDay() {
                const days = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
                return days[new Date().getDay()];
            },

            formatTime(minutes) {
                const hrs = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hrs > 0 ? `${hrs} ساعة ${mins} دقيقة` : `${mins} دقيقة`;
            },

            generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            },

            validateChildData(childData) {
                const errors = [];
                
                if (!childData.name || childData.name.trim().length < 2) {
                    errors.push("اسم الطفل يجب أن يكون على الأقل حرفين");
                }
                
                if (childData.birthDate) {
                    const birthDate = new Date(childData.birthDate);
                    const today = new Date();
                    if (birthDate > today) {
                        errors.push("تاريخ الميلاد لا يمكن أن يكون في المستقبل");
                    }
                }
                
                if (childData.subjects.length === 0) {
                    errors.push("يجب إضافة مادة واحدة على الأقل");
                }
                
                return errors;
            }
        };

        // Firebase Service
        const firebaseService = {
            db: null,
            initialized: false,
            error: null,

            init() {
                try {
                    console.log("🔄 جاري تهيئة Firebase...");
                    
                    // التحقق من وجود FIREBASE_CONFIG
                    if (typeof FIREBASE_CONFIG === 'undefined') {
                        this.error = "FIREBASE_CONFIG غير معرّف";
                        console.error(this.error);
                        return false;
                    }

                    // التحقق من بيانات التكوين
                    if (!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.projectId.includes('your-project')) {
                        this.error = "⚠️ يرجى تكوين Firebase باستخدام بيانات مشروعك الحقيقية";
                        console.warn(this.error);
                        return false;
                    }

                    const app = firebase.initializeApp(FIREBASE_CONFIG);
                    this.db = firebase.firestore();
                    
                    // تمكين وضع عدم الاتصال
                    this.db.enablePersistence().catch((err) => {
                        console.warn('تعطيل وضع عدم الاتصال:', err);
                    });

                    this.initialized = true;
                    console.log("✅ تم تهيئة Firebase بنجاح");
                    return true;
                } catch (error) {
                    this.error = `❌ فشل تهيئة Firebase: ${error.message}`;
                    console.error(this.error);
                    return false;
                }
            },

            async getCollection(collectionName) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return [];
                }
                try {
                    const snapshot = await this.db.collection(collectionName).get();
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`✅ تم تحميل ${data.length} مستند من ${collectionName}`);
                    return data;
                } catch (error) {
                    console.error(`❌ خطأ في جلب ${collectionName}:`, error);
                    throw error;
                }
            },

            async saveDocument(collectionName, document) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return null;
                }
                try {
                    let docId;
                    if (document.id && document.id.length > 10) {
                        await this.db.collection(collectionName).doc(document.id).set(document, { merge: true });
                        docId = document.id;
                        console.log(`✅ تم تحديث المستند ${docId} في ${collectionName}`);
                    } else {
                        const docRef = await this.db.collection(collectionName).add(document);
                        docId = docRef.id;
                        console.log(`✅ تم إنشاء مستند جديد ${docId} في ${collectionName}`);
                    }
                    return docId;
                } catch (error) {
                    console.error(`❌ خطأ في الحفظ في ${collectionName}:`, error);
                    throw error;
                }
            },

            async deleteDocument(collectionName, docId) {
                if (!this.initialized) {
                    console.warn("Firebase غير مهيء");
                    return false;
                }
                try {
                    await this.db.collection(collectionName).doc(docId).delete();
                    console.log(`✅ تم حذف المستند ${docId} من ${collectionName}`);
                    return true;
                } catch (error) {
                    console.error(`❌ خطأ في الحذف من ${collectionName}:`, error);
                    throw error;
                }
            }
        };

        // نظام مراقبة الاتصال
        const ConnectionManager = {
            isOnline: navigator.onLine,
            retryCount: 0,
            maxRetries: 3,

            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('✅ الاتصال عاد');
                    this.retryConnection();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('❌ فقدان الاتصال');
                });

                setInterval(() => {
                    if (!this.isOnline && this.retryCount < this.maxRetries) {
                        this.retryConnection();
                    }
                }, 5000);
            },

            async retryConnection() {
                if (!this.isOnline) return;
                
                try {
                    this.retryCount++;
                    console.log(`🔄 محاولة إعادة الاتصال (${this.retryCount}/${this.maxRetries})`);
                    
                    await this.testFirebaseConnection();
                    this.retryCount = 0;
                    console.log('✅ إعادة الاتصال ناجحة');
                } catch (error) {
                    console.error(`❌ فشل إعادة الاتصال: ${error.message}`);
                }
            },

            async testFirebaseConnection() {
                if (!firebaseService.initialized) return false;
                
                try {
                    const testRef = firebaseService.db.collection('connection_test').doc('ping');
                    await testRef.set({
                        timestamp: new Date().toISOString(),
                        status: 'testing'
                    });
                    return true;
                } catch (error) {
                    throw new Error(`فشل اختبار الاتصال: ${error.message}`);
                }
            }
        };

        // مكون حالة الاتصال
        function ConnectionStatus({ firebaseService }) {
            const [connectionInfo, setConnectionInfo] = useState({
                status: 'checking',
                lastSync: null
            });

            useEffect(() => {
                const checkConnection = async () => {
                    if (firebaseService.initialized) {
                        try {
                            await ConnectionManager.testFirebaseConnection();
                            setConnectionInfo({
                                status: 'connected',
                                lastSync: new Date()
                            });
                        } catch (error) {
                            setConnectionInfo({
                                status: 'disconnected',
                                lastSync: new Date()
                            });
                        }
                    } else {
                        setConnectionInfo({
                            status: 'disconnected',
                            lastSync: null
                        });
                    }
                };

                if (firebaseService.initialized) {
                    checkConnection();
                    const interval = setInterval(checkConnection, 30000);
                    return () => clearInterval(interval);
                }
            }, [firebaseService.initialized]);

            const statusColors = {
                connected: 'bg-green-500',
                disconnected: 'bg-red-500',
                checking: 'bg-yellow-500'
            };

            if (!firebaseService.initialized && !firebaseService.error) return null;

            return (
                <div className="fixed bottom-4 left-4 z-40">
                    <div className={`p-3 rounded-lg shadow-lg text-white ${
                        statusColors[connectionInfo.status] || 'bg-gray-500'
                    }`}>
                        <div className="flex items-center gap-2">
                            <div className={`w-3 h-3 rounded-full ${
                                connectionInfo.status === 'connected' ? 'bg-green-400 animate-pulse' :
                                connectionInfo.status === 'disconnected' ? 'bg-red-400' : 'bg-yellow-400'
                            }`}></div>
                            <span className="text-sm font-bold">
                                {connectionInfo.status === 'connected' ? '☁️ متصل' :
                                 connectionInfo.status === 'disconnected' ? '❌ غير متصل' : '🔄 جاري الفحص'}
                            </span>
                        </div>
                        {firebaseService.error && (
                            <div className="text-xs mt-1 max-w-xs">
                                {firebaseService.error}
                            </div>
                        )}
                        {connectionInfo.lastSync && (
                            <div className="text-xs mt-1 opacity-80">
                                آخر محاولة: {connectionInfo.lastSync.toLocaleTimeString('ar-EG')}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main App Component
        const { useState, useEffect, useCallback, useMemo } = React;

        function App() {
            const [appState, setAppState] = useState({
                step: 0,
                children: [],
                currentChildIndex: 0,
                activeTab: "الرئيسية",
                darkMode: false,
                useFirebase: false,
                loading: false
            });

            const [newChild, setNewChild] = useState({
                name: "",
                birthDate: "",
                focusLevel: "متوسط",
                wakeTime: "05:30",
                sleepTime: "20:30",
                subjects: [],
                exams: [],
                weeklySchedule: Object.fromEntries(DAYS_OF_WEEK.map(day => [day, []])),
                goals: [],
                stars: 0,
                completed: [],
                achievements: [],
                studyTime: 0,
                avatar: "👦",
                createdAt: new Date().toISOString()
            });

            const [rewards, setRewards] = useState(DEFAULT_REWARDS);
            const [notification, setNotification] = useState({ show: false, message: "", type: "" });
            const [studyTimer, setStudyTimer] = useState({ active: false, startTime: null, currentSubject: null });
            const [dailyPlan, setDailyPlan] = useState([]);

            // Initialize Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    setAppState(prev => ({ ...prev, loading: true }));
                    
                    if (firebaseService.init()) {
                        setAppState(prev => ({ ...prev, useFirebase: true }));
                        showNotification("✅ تم الاتصال بقاعدة البيانات السحابية", "success");
                        
                        try {
                            const [childrenData, rewardsData] = await Promise.all([
                                firebaseService.getCollection('children'),
                                firebaseService.getCollection('rewards')
                            ]);
                            
                            if (childrenData.length > 0) {
                                setAppState(prev => ({ ...prev, children: childrenData }));
                            }
                            
                            if (rewardsData.length > 0) {
                                setRewards(rewardsData);
                            }
                        } catch (error) {
                            console.error("Error loading data:", error);
                            showNotification("⚠️ تم التحميل من التخزين المحلي", "info");
                            loadFromLocalStorage();
                        }
                    } else {
                        loadFromLocalStorage();
                        showNotification("📱 يتم استخدام التخزين المحلي", "info");
                    }
                    
                    setAppState(prev => ({ ...prev, loading: false }));
                };

                initFirebase();
                ConnectionManager.init();
            }, []);

            const loadFromLocalStorage = useCallback(() => {
                try {
                    const storedChildren = localStorage.getItem("childrenData");
                    const storedRewards = localStorage.getItem("rewardsData");
                    const storedDarkMode = localStorage.getItem("darkMode");
                    
                    if (storedChildren) setAppState(prev => ({ ...prev, children: JSON.parse(storedChildren) }));
                    if (storedRewards) setRewards(JSON.parse(storedRewards));
                    if (storedDarkMode) setAppState(prev => ({ ...prev, darkMode: JSON.parse(storedDarkMode) }));
                } catch (error) {
                    console.error("Error loading from localStorage:", error);
                }
            }, []);

            const saveToLocalStorage = useCallback(() => {
                try {
                    localStorage.setItem("childrenData", JSON.stringify(appState.children));
                    localStorage.setItem("rewardsData", JSON.stringify(rewards));
                    localStorage.setItem("darkMode", JSON.stringify(appState.darkMode));
                } catch (error) {
                    console.error("Error saving to localStorage:", error);
                }
            }, [appState.children, rewards, appState.darkMode]);

            // Auto-save
            useEffect(() => {
                if (appState.children.length > 0 || rewards.length > 0) {
                    saveToLocalStorage();
                    
                    if (appState.useFirebase && firebaseService.initialized) {
                        appState.children.forEach(child => {
                            firebaseService.saveDocument('children', child).catch(error => {
                                console.error("Failed to sync child:", error);
                            });
                        });
                        rewards.forEach(reward => {
                            firebaseService.saveDocument('rewards', reward).catch(error => {
                                console.error("Failed to sync reward:", error);
                            });
                        });
                    }
                }
            }, [appState.children, rewards, appState.darkMode, appState.useFirebase, saveToLocalStorage]);

            const showNotification = useCallback((message, type = "info") => {
                setNotification({ show: true, message, type });
                setTimeout(() => setNotification({ show: false, message: "", type: "" }), 4000);
            }, []);

            // Child Management
            const addChild = useCallback((childData) => {
                const validationErrors = utils.validateChildData(childData);
                if (validationErrors.length > 0) {
                    validationErrors.forEach(error => showNotification(error, "error"));
                    return;
                }

                const childWithId = { ...childData, id: utils.generateId() };
                setAppState(prev => ({
                    ...prev,
                    children: [...prev.children, childWithId],
                    step: 1
                }));
                showNotification(`تمت إضافة الطفل ${childData.name} بنجاح`, "success");
            }, [showNotification]);

            const updateChild = useCallback((childIndex, updates) => {
                setAppState(prev => ({
                    ...prev,
                    children: prev.children.map((child, index) =>
                        index === childIndex ? { ...child, ...updates } : child
                    )
                }));
            }, []);

            const deleteChild = useCallback((childIndex) => {
                const childName = appState.children[childIndex]?.name;
                if (!childName || !window.confirm(`هل أنت متأكد من حذف ${childName}؟`)) return;

                setAppState(prev => ({
                    ...prev,
                    children: prev.children.filter((_, index) => index !== childIndex),
                    currentChildIndex: prev.currentChildIndex >= childIndex && prev.currentChildIndex > 0 
                        ? prev.currentChildIndex - 1 
                        : prev.currentChildIndex
                }));

                if (appState.useFirebase) {
                    firebaseService.deleteDocument('children', appState.children[childIndex].id);
                }

                showNotification(`تم حذف الطفل ${childName}`, "info");
            }, [appState.children, appState.useFirebase, showNotification]);

            return (
                <div className={`min-h-screen transition-colors duration-300 ${appState.darkMode ? 'dark-mode' : 'bg-gradient-to-br from-blue-50 to-purple-50'}`}>
                    {/* مؤشر الاتصال */}
                    {appState.useFirebase && <ConnectionStatus firebaseService={firebaseService} />}
                    
                    {/* الإشعارات */}
                    {notification.show && (
                        <div className={`fixed top-4 left-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in glass-effect ${
                            notification.type === "success" ? "notification-success" :
                            notification.type === "error" ? "notification-error" :
                            "notification-info"
                        }`}>
                            <div className="flex justify-between items-center">
                                <span className="text-lg text-white">{notification.message}</span>
                                <button 
                                    onClick={() => setNotification({ show: false, message: "", type: "" })} 
                                    className="text-lg font-bold hover:opacity-70 text-white"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    )}

                    {/* شاشة التحميل */}
                    {appState.loading && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass-effect rounded-2xl p-8 flex flex-col items-center">
                                <div className="loading-spinner mb-4"></div>
                                <div className="text-white text-lg">جاري تحميل البيانات...</div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-7xl mx-auto p-4 container-padding">
                        {/* الهيدر */}
                        <header className="text-center mb-8 pt-4">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setAppState(prev => ({ ...prev, darkMode: !prev.darkMode }))}
                                        className="p-3 rounded-full glass-effect hover-lift"
                                        title={appState.darkMode ? "الوضع النهاري" : "الوضع الليلي"}
                                    >
                                        {appState.darkMode ? "☀️" : "🌙"}
                                    </button>
                                    {appState.useFirebase && (
                                        <div className="p-3 rounded-full glass-effect firebase-badge">
                                            ☁️
                                        </div>
                                    )}
                                </div>
                                
                                <h1 className="text-4xl font-bold text-white flex items-center justify-center gap-2">
                                    <span className="float-animation">⭐</span>
                                    نجم التركيز
                                    <span className="float-animation">⭐</span>
                                </h1>
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => {
                                            const data = {
                                                children: appState.children,
                                                rewards: rewards,
                                                exportDate: new Date().toISOString(),
                                                version: "2.0"
                                            };
                                            const dataStr = JSON.stringify(data, null, 2);
                                            const dataBlob = new Blob([dataStr], { type: 'application/json' });
                                            const url = URL.createObjectURL(dataBlob);
                                            const link = document.createElement('a');
                                            link.href = url;
                                            link.download = `star-focus-backup-${new Date().toISOString().split('T')[0]}.json`;
                                            link.click();
                                            showNotification("تم تصدير البيانات بنجاح", "success");
                                        }}
                                        className="p-3 rounded-full glass-effect hover-lift text-white"
                                        title="تصدير البيانات"
                                    >
                                        📥
                                    </button>
                                    <label className="p-3 rounded-full glass-effect hover-lift text-white cursor-pointer" title="استيراد البيانات">
                                        📤
                                        <input 
                                            type="file" 
                                            accept=".json" 
                                            onChange={(event) => {
                                                const file = event.target.files[0];
                                                if (!file) return;

                                                const reader = new FileReader();
                                                reader.onload = function(e) {
                                                    try {
                                                        const data = JSON.parse(e.target.result);
                                                        if (data.children) setAppState(prev => ({ ...prev, children: data.children }));
                                                        if (data.rewards) setRewards(data.rewards);
                                                        showNotification("تم استيراد البيانات بنجاح", "success");
                                                    } catch (error) {
                                                        showNotification("خطأ في استيراد البيانات", "error");
                                                        console.error("Error importing data:", error);
                                                    }
                                                };
                                                reader.readAsText(file);
                                                event.target.value = '';
                                            }}
                                            className="hidden"
                                        />
                                    </label>
                                </div>
                            </div>
                            <p className="text-lg opacity-80 text-white">
                                {appState.useFirebase ? "منصة متكاملة مع قاعدة بيانات السحابة" : "منصة متكاملة للتخزين المحلي"}
                            </p>
                        </header>

                        {/* المحتوى الرئيسي */}
                        {appState.step === 0 ? (
                            // شاشة إضافة الأطفال
                            <div className="glass-effect rounded-2xl p-6 shadow-xl fade-in">
                                <div className="max-w-4xl mx-auto">
                                    <h2 className="text-3xl font-bold text-center mb-8 text-white">إضافة طفل جديد</h2>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block mb-2 text-lg text-white">الصورة الرمزية</label>
                                                <div className="flex items-center gap-4">
                                                    <button 
                                                        onClick={() => setNewChild(prev => ({ 
                                                            ...prev, 
                                                            avatar: AVATARS[(AVATARS.indexOf(prev.avatar) + 1) % AVATARS.length] 
                                                        }))}
                                                        className="text-4xl p-4 rounded-2xl glass-effect hover-lift"
                                                    >
                                                        {newChild.avatar}
                                                    </button>
                                                    <span className="text-sm opacity-70 text-white">انقر لتغيير الصورة</span>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label className="block mb-2 text-lg text-white">اسم الطفل</label>
                                                <input 
                                                    type="text"
                                                    value={newChild.name}
                                                    onChange={(e) => setNewChild(prev => ({ ...prev, name: e.target.value }))}
                                                    placeholder="أدخل اسم الطفل"
                                                    className="w-full p-3 rounded-xl glass-effect text-white placeholder-gray-300"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block mb-2 text-lg text-white">تاريخ الميلاد</label>
                                                <input 
                                                    type="date"
                                                    value={newChild.birthDate}
                                                    onChange={(e) => setNewChild(prev => ({ ...prev, birthDate: e.target.value }))}
                                                    className="w-full p-3 rounded-xl glass-effect text-white"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block mb-2 text-lg text-white">مستوى التركيز</label>
                                                <div className="flex gap-2">
                                                    {FOCUS_LEVELS.map(level => (
                                                        <button
                                                            key={level}
                                                            onClick={() => setNewChild(prev => ({ ...prev, focusLevel: level }))}
                                                            className={`flex-1 p-4 rounded-xl transition-all ${
                                                                newChild.focusLevel === level 
                                                                    ? 'bg-white bg-opacity-30 text-white shadow-lg' 
                                                                    : 'glass-effect hover-lift text-white'
                                                            }`}
                                                        >
                                                            {level}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label className="block mb-2 text-lg text-white">وقت الاستيقاظ</label>
                                                <input 
                                                    type="time"
                                                    value={newChild.wakeTime}
                                                    onChange={(e) => setNewChild(prev => ({ ...prev, wakeTime: e.target.value }))}
                                                    className="w-full p-3 rounded-xl glass-effect text-white"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block mb-2 text-lg text-white">وقت النوم</label>
                                                <input 
                                                    type="time"
                                                    value={newChild.sleepTime}
                                                    onChange={(e) => setNewChild(prev => ({ ...prev, sleepTime: e.target.value }))}
                                                    className="w-full p-3 rounded-xl glass-effect text-white"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* المواد الدراسية */}
                                    <div className="mb-6">
                                        <h3 className="text-xl font-bold mb-4 text-white">المواد الدراسية</h3>
                                        <div className="space-y-2 mb-4">
                                            {newChild.subjects.length === 0 ? (
                                                <p className="text-white text-center py-4">لم يتم إضافة أي مواد بعد</p>
                                            ) : (
                                                newChild.subjects.map((subject, index) => (
                                                    <div key={index} className="flex justify-between items-center p-3 glass-effect rounded-xl">
                                                        <span className="text-white">{subject.name} - {subject.duration} دقيقة</span>
                                                        <button 
                                                            onClick={() => setNewChild(prev => ({
                                                                ...prev,
                                                                subjects: prev.subjects.filter((_, i) => i !== index)
                                                            }))}
                                                            className="text-red-400 hover:text-red-300"
                                                        >
                                                            حذف
                                                        </button>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                        <button 
                                            onClick={() => {
                                                const name = prompt("أدخل اسم المادة:");
                                                if (!name) return;
                                                
                                                const duration = parseInt(prompt("أدخل مدة المادة بالدقائق:"), 10);
                                                if (isNaN(duration)) {
                                                    showNotification("الرجاء إدخال رقم صحيح للمدة", "error");
                                                    return;
                                                }

                                                setNewChild(prev => ({
                                                    ...prev,
                                                    subjects: [...prev.subjects, { name, duration, id: utils.generateId() }]
                                                }));
                                                showNotification(`تمت إضافة مادة ${name}`, "success");
                                            }}
                                            className="w-full p-3 glass-effect rounded-xl text-white hover:bg-white hover:bg-opacity-20 transition-all"
                                        >
                                            + إضافة مادة جديدة
                                        </button>
                                    </div>
                                    
                                    <button 
                                        onClick={() => addChild(newChild)}
                                        className="w-full bg-white bg-opacity-20 text-white p-4 rounded-2xl text-xl font-bold hover:bg-opacity-30 transition-all"
                                    >
                                        بدء الرحلة التعليمية 🚀
                                    </button>
                                </div>
                            </div>
                        ) : appState.children.length === 0 ? (
                            <div className="text-center py-12">
                                <p className="text-white text-xl mb-4">لا يوجد أطفال مسجلين</p>
                                <button
                                    onClick={() => setAppState(prev => ({ ...prev, step: 0 }))}
                                    className="bg-blue-500 text-white p-4 rounded-2xl text-lg hover:bg-blue-600 transition-all"
                                >
                                    إضافة أول طفل
                                </button>
                            </div>
                        ) : (
                            <div className="text-center py-12">
                                <p className="text-white text-xl mb-4">التطبيق جاهز للتشغيل! ✅</p>
                                <p className="text-white opacity-80 mb-4">Firebase متصل بنجاح</p>
                                <p className="text-white opacity-60">عدد الأطفال: {appState.children.length}</p>
                                <p className="text-white opacity-60">عدد المكافآت: {rewards.length}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Initialize App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
